Title: CAP Theorem Meets ATMs
Date: 2025-09-14
Category: Distributed Systems
Tags: CAPTheorem, ATM, Banking
Slug: cap-atm
Author: Priyanshu Bishnoi
Summary: How distributed systems and CAP theorem explain why some ATMs work while others fail.

## let’s stitch your whole thought process into one clean storyline — from CAP theorem all the way down to real-world ATMs.

## 🧩 1. CAP Theorem Basics

* C (Consistency): everyone sees the same data.

* A (Availability): system always responds.

* P (Partition tolerance): system survives network splits.

In real distributed systems → P is unavoidable, so tradeoff is C vs A during partitions.

## 🧩 2. Simple Scenario: Double Withdrawals

* Balance = 1000, replicated at M1 and M2.

* Partition occurs → no sync.

* ATM hits M1 → withdraw 500 (balance 500).

* ATM hits M2 → withdraw 1000 (balance 0).

* Customer walks away with 1500 🥲.

* When partition heals → conflict must be resolved.

* AP (Availability + Partition tolerance) → both withdrawals succeed → double spend.

* CP (Consistency + Partition tolerance) → one withdrawal would have been blocked.

## 🧩 3. Quorum & Replicas

* To prevent both sides from “thinking they’re right,” quorum is used.

* Minimum 3 replicas needed → majority wins.

* With 2 replicas → both can believe they’re valid (split-brain).

* So banks & serious CP systems always run with odd number of replicas and leader election.

## 🧩 4. Banks in Real Life

* Banks run multi-DC (multi–data center) replication.

* Withdrawals = CP (must talk to global quorum).

* Balance inquiries = AP (can serve slightly stale reads).

* If one DC is cut off, ATMs connected to it → fail (“Service unavailable”).

* Other ATMs connected to healthy quorum → succeed.

* That’s why “ATM across the road works, but this one doesn’t.”

## 🧩 5. Cross-Bank Transactions

* Flow = ATM (HDFC) → HDFC Switch → NPCI → Kotak (issuer).

* Issuer (Kotak) = final authority on approval.

* Acquirer (HDFC ATM) = just dispenser + logger.

* End of day → NPCI nets out balances → RBI settles between banks.

## 🧩 6. Edge Cases

* **ATM low on cash:**

* Kotak may approve 10k, but HDFC ATM has only 4k.

* ATM either:

* Does partial dispense + informs Kotak (account debited 4k).

* Or cancels txn (no debit).

* If mismatch → corrected in reconciliation.

* **ATM crash before reconciliation:**

* Cash may/may not have been dispensed, but logs not sent.

* Mismatch detected during settlement window.

* Auto-reversal (T+1/T+2 days) ensures customer doesn’t lose money.

* If not → customer dispute → forced correction.

## ✅ Summary in One Line

##### From CAP theorem to banks: distributed systems must pick CP for money safety → which is why sometimes your ATM fails while another works → issuer always decides, acquirer just dispenses → low cash and crash scenarios get fixed later during reconciliation → but in the moment, you see all the weirdness.